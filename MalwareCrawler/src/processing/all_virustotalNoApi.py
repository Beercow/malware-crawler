# Copyright (C) 2013-2014 Ragpicker Developers.
# This file is part of Ragpicker Malware Crawler - http://code.google.com/p/malware-crawler/

import logging
import BeautifulSoup

from core.abstracts import Processing

try:
    from yapsy.IPlugin import IPlugin
except ImportError:
    raise ImportError, 'Yapsy (Yet Another Plugin System) is required to run this program : http://yapsy.sourceforge.net'

log = logging.getLogger("ProcessingVirustotalNoApi")

VIRUSTOTAL_FILE_URL = 'https://www.virustotal.com/de/search/?query=%s'

class VirustotalNoApi(IPlugin, Processing):
    
    def run(self, objfile):
        self.key = "VirusTotal"
        self.score = -1
        returnValue = {}
        
        # Check file md5
        vt_file = self._vt_file(objfile)
        returnValue.update(vt_file)
        
        return returnValue
    
    def _fileFound(self, soup):
        s = soup.find("h2", { "class" : "alert-heading" })

        if s:
            s = str(s)
            i = s.find("Datei nicht gefunden")
            if i > 0:
                return False
        
        return True
    
    def _vt_file(self, objfile):
        returnValue = {}
        result = {}
        log.debug("MD5=%s" % objfile.file.get_fileMd5())
    
        # parser
        soup = self.parse(VIRUSTOTAL_FILE_URL % objfile.file.get_fileMd5())
        
        # Extract detection rate
        if self._fileFound(soup):
            try:
                s = soup.find(text='Erkennungsrate:')
                while getattr(s, 'name', None) != 'td':
                    s = s.next
                
                s = str(s.contents[0])
                s = s.replace('\n', "").replace(' ', "")
                
                s = s.split('/')
                
                positives = s[0]
                total = s[1]
                
                # calculate scoring
                if int(positives) == 0:
                    self.score = 0
                elif int(positives) <= 1:
                    self.score = 5
                elif int(positives) <= 2:
                    self.score = 8
                elif int(positives) >= 3:
                    self.score = 10
                    
                result["positives"] = positives
                result["total"] = total  
            except Exception, e:
                log.error("%s - Error Determining the detection rate" % e)
                return
            
            # Extract Scan-Date 
            try:
                s = soup.find(text='Analyse-Datum:')
                while getattr(s, 'name', None) != 'td':
                    s = s.next
                
                s = str(s.contents[0])
                s = s.replace('\n', "").replace('  ', "").replace('( ', " ( ")
                
                result["scan_date"] = s
            except Exception, e:
                log.error("%s - Error Determining the scan date" % e)
                return
            
            # Extract First submission
            try:
                s = soup.find(text="First submission").parent.parent.contents[2]
                s = str(s)
                s = s.replace('\n', "").replace('  ', "")
                
                result["first_submission"] = s
            except Exception, e:
                log.error("%s - Error Determining the First submission date" % e)
                return
            
            # Extract Filenames
            try:
                dateinamen = []
                s = soup.find(text="Dateinamen")
                s = s.parent.parent.parent
                s = s.prettify()
                s = s.replace('<br />', "").replace('\n', "|").replace(' ', "")
                s = s.split("|")
                
                for dateiname in s:
                    if "<" not in dateiname and "Dateinamen" not in dateiname and dateiname != "":
                        dateinamen.append(dateiname)
                
                result["filenames"] = dateinamen
            except Exception, e:
                log.error("%s - Error Determining filenames" % e)
                return            
        else: 
            result["verbose_msg"] = "File not found on VirusTotal"
            
        returnValue["file"] = result
        log.debug(returnValue)
        return returnValue
