#!/usr/bin/env python
import os.path
import shutil
import sys

import utils.magic as magic


def get_type(file):
    """Get MIME file type.
    @return: file type.
    """
    try:
        file_type = magic.from_file(file)
    except:
        try:
            import subprocess
            file_process = subprocess.Popen(['file', '-b', file],
                                            stdout=subprocess.PIPE)
            file_type = file_process.stdout.read().strip()
        except:
            return None

    file_type = file_type.split(' ')[0]
    file_type = file_type.replace("/", "_")
    return file_type

source = sys.argv[1]
destination = sys.argv[2]

while not os.path.exists(source):
    source = raw_input('Enter a valid source directory\n')
while not os.path.exists(destination):
    destination = raw_input('Enter a valid destination directory\n')
        
for root, dirs, files in os.walk(source, topdown=False):
    for file in files:
        extension = get_type(os.path.join(source, file))
        destinationPath = os.path.join(destination, extension)
          
        if not os.path.exists(destinationPath):
                os.mkdir(destinationPath)
        if os.path.exists(os.path.join(destinationPath, file)):
                print 'WARNING: this file was not copied :' + os.path.join(root, file)
        else:
            shutil.copy2(os.path.join(root, file), destinationPath)
